---
title: "WASM 가지고 놀아보기 (BASE64 인코더·디코더)"
description: "WASM 만들어 본 후기."
layout: post
tags: ["잡담","WASM"]
---

<p><a href='/i/base64' title='BASE64'>이거 만들었어요.</a></p>
<p>WASM, 웹 어셈블리, 그 이름을 듣자마자 저는 참을 수 없었습니다. 범용 어셈블리라니! 게다가 웹 용이라니!</p>
<p>저는 저수준 언어를 좋아합니다. 다만 다룰 능력이 부족할 뿐입니다. 저는 포인터, 비트 연산, 이런 쓸데없는 최적화에 대한 애정이 있습니다. 근데 웹에서! 범용 플랫폼에서 그게 가능하다고 하니 정말 매력적으로 다가왔습니다.</p>

<h2>WASM에 대해서</h2>

<p>이번에 개발해 보면서 알게 된 잡지식이자 WASM의 매력은 이런 것이 있습니다.</p>

<h3>C</h3>

<p>C와 C++은 정말 웹과 거리가 먼 것 같습니다. 하지만 WASM을 통해서는 쓸 수 있습니다.</p>
<p>또 C++이 아니라 C, 그것도 라이브러리를 전부 배제하고 쓸 수 있습니다. 뭐가 먼저였는지는 기억이 안 납니다. 라이브러리를 쓰지 않아야 컴파일 할 수 있었던 걸지도 모르겠습니다. 어쨌든 용량은 정말 작습니다. 심지어 WASM 파일을 불러오기 위한 JS 파일이 더 큽니다.</p>
<p>이런 짓을 할 수 있는 이유는 WASM 파일이 스스로 동작할 수 없기 때문입니다. 무조건 JS 안에서 호출해서 사용해야 합니다. 호출하면 마음대로 할 수 있냐? 아닙니다. WASM은 웹의 어느 것도 조작하지 못합니다.</p>

<h3>WASM 메모리</h3>

<p>대신 가상의 메모리에 접근할 수 있습니다. JS에서 만들어 줘야 하지만요.</p>
<p>여기서 제가 좋아하는 내용이 잔뜩 나옵니다. 이 메모리를 사용하는 방식이 정말 직접적입니다. 꼭 그래야 하는지는 잘 모르겠습니다. 그렇지만 메모리 주소를 주고 받고, 사용할 공간을 남겨두고 이런 동작들이 정말 낭만적이라고 생각합니다.</p>

<h2>그래서 어떻게 하는 건데?</h2>

<p>제가 하나부터 열까지 알려드릴 수는 없지만 시간 단축용 팁을 전해드릴 수는 있을 것 같습니다.</p>

<h3>컴파일 옵션</h3>

<p>아마 대부분 clang을 기반으로 할 거예요. 그런데 웹에서 쓰려면 조건이 필요합니다. 라이브러리 의존성이 없을 것, 사용할 함수를 지정할 것, 외부의 메모리를 사용한다고 알릴 것, main 함수가 없다고 알릴 것.</p>
<ul>
  <li><code>--target=wasm32</code></li>
  <li><code>-Wl,--export-dynamic</code></li>
  <li><code>-Wl,--import-memory</code></li>
  <li><code>-Wl,--no-entry</code></li>
</ul>
<p>이런 옵션을 넣어주셔야 합니다. 특히 export(어떤 함수를 JS와 연결할지 결정) 관련해서는 다양한 선택지가 있습니다. 코드 안에서 알려줄지, 컴파일 옵션으로 알려줄지, 모두 내보낼지 등등.</p>
<p>("undefined symbol" 오류가 뜨면 대부분 <code>--no-entry</code> 관련입니다.)</p>

<h3>메모리</h3>

<p>JS에서 먼저 선언을 합니다. <code>new WebAssembly.Memory()</code>라는 함수를 써서요. (크기 지정하는 부분이 생략됐으니 그대로 쓰시면 안됩니다!) 그리고 <code>WebAssembly.instantiate()</code> 혹은 <code>WebAssembly.instantiateStreaming()</code>을 이용해서 wasm 파일을 불러와요. 이때 아까 만들었던 메모리를 같이 넘겨주고요. 그러면 wasm 쪽에서 <code>extern</code>을 이용해 사용할 수 있습니다.</p>
<p>여기서 Heap Base 기능이 정말 유용합니다! 이게 힙 메모리의 시작 주소를 알려주는 거예요. 처음에 "가상 메모리니까 그냥 0부터 쓰면 되겠지?" 했다가 많이 헤맸습니다. 제미나이 말로는 wasm 안에서 선언하는 변수까지 거기서 처리한다고 하더라고요.</p>

<h2>마무리</h2>

<p>생각보다 오래된 기술이더라고요. 강력함에 비해 정보가 의외로 적어서 이런 허접한 글이라도 남깁니다. 아 근데 진작 몰랐던 게 아쉽네요. 하 인생 손해봤다</p>
